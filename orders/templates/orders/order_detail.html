{% extends "base.html" %}
{% load static %}

{% block title %}Заказ №{{ order.order_number }}{% endblock %}

{% block extra_head %}
{# ... (existing extra_head content) ... #}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />

<link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet" />
<style>
    body {
        background-color: #f8f9fa; /* Light grey background */
        font-family: 'Inter', sans-serif; /* Modern font, consider adding Google Fonts link if not already */
        color: #343a40; /* Dark grey for text */
    }

    .main-detail-section {
        padding: 4rem 0; /* More padding top/bottom */
    }

    /* Container for the page content */
    .container {
        max-width: 1000px; /* Max width for readability */
    }

    /* Main Card Styling */
    .content-card {
        background-color: #ffffff;
        border-radius: 16px; /* More rounded corners */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* Softer, larger shadow */
        padding: 3rem; /* Generous padding */
        margin-bottom: 2.5rem; /* Space between cards */
        border: 1px solid #e9ecef; /* Subtle border */
    }

    /* Headings */
    h1, h2, h3 {
        font-weight: 700;
        color: #212529;
        margin-bottom: 1.5rem;
    }
    h1 { font-size: 2.8rem; text-align: center; margin-bottom: 2rem; }
    h2 { font-size: 2.2rem; text-align: center; margin-bottom: 2.5rem; position: relative; }
    h2::after {
        content: '';
        position: absolute;
        left: 50%;
        bottom: -10px; /* Move underline slightly down */
        transform: translateX(-50%);
        width: 80px;
        height: 5px; /* Thicker underline */
        background-color: #007bff; /* Primary accent color */
        border-radius: 3px;
    }
    h3 { font-size: 1.8rem; margin-bottom: 1.5rem; color: #495057; }


    /* Status Badge */
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.75rem 1.5rem;
        border-radius: 30px; /* Pill shape */
        font-size: 1.1rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .status-new { background-color: #e0e7eb; color: #5a6268; } /* Light grey */
    .status-in-progress { background-color: #ffeeb3; color: #d69d00; } /* Soft yellow */
    .status-completed { background-color: #d4edda; color: #28a745; } /* Light blue for completed */
    .status-canceled { background-color: #f8d7da; color: #dc3545; } /* Light red for canceled */


    /* Order Info Section */
    .order-info p {
        font-size: 1.1rem;
        margin-bottom: 0.8rem;
        color: #555;
    }
    .order-info strong {
        color: #333;
    }
    .order-info .meta-data {
        font-size: 0.95rem;
        color: #777;
        margin-top: 1.5rem;
        border-top: 1px dashed #e9ecef;
        padding-top: 1rem;
    }

    /* --- Progress Bar Styles (Retained and Enhanced from last step) --- */
    .progress-section {
        margin-top: 3rem;
        margin-bottom: 3rem;
    }
    .progress-timeline {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        position: relative;
        padding: 0;
        margin-bottom: 1.5rem;
    }
    .progress-timeline-line {
        position: absolute;
        top: 30px;
        left: 0;
        right: 0;
        height: 6px;
        background-color: #e0e0e0;
        border-radius: 3px;
        z-index: 1;
        transform: translateY(-50%);
    }
    .progress-line-fill {
        position: absolute;
        top: 30px;
        left: 0;
        height: 6px;
        background-color: #007bff;
        border-radius: 3px;
        z-index: 2;
        transform: translateY(-50%);
        transition: width 0.7s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    .progress-step {
        position: relative;
        z-index: 3;
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding-top: 50px;
        min-width: 0;
    }
    .progress-step-icon-wrapper {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 60px;
        background-color: #f8f9fa;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        color: #888;
        border: 4px solid #ced4da;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease, transform 0.3s ease-out;
    }

    .progress-step.completed .progress-step-icon-wrapper {
        background-color: #007bff;
        color: #ffffff;
        border-color: #007bff;
        transform: translateX(-50%) scale(1.05);
    }
    .progress-step.current .progress-step-icon-wrapper {
        background-color: #ffc107; /* Yellow accent */
        color: #ffffff;
        border-color: #ffc107;
        box-shadow: 0 0 0 8px rgba(255,193,7,0.3);
        animation: pulse-ring 1.5s infinite;
    }

    @keyframes pulse-ring {
        0% { box-shadow: 0 0 0 0 rgba(255,193,7,0.3); }
        70% { box-shadow: 0 0 0 10px rgba(255,193,7,0); }
        100% { box-shadow: 0 0 0 0 rgba(255,193,7,0); }
    }

    .progress-step-label {
        font-size: 0.95rem;
        color: #555;
        font-weight: 600;
        margin-top: 1.2rem;
        line-height: 1.3;
    }
    .progress-step.completed .progress-step-label {
        color: #333;
    }

    /* Media Gallery Section */
    .media-gallery-container {
        padding: 2rem; /* More padding */
        background-color: #f0f4f8; /* Slightly darker background for media */
        border-radius: 12px;
        margin-bottom: 2.5rem;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05); /* Inner shadow */
    }
    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive grid */
        gap: 1.5rem; /* Space between items */
    }
    .media-item-card {
        background-color: #ffffff;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        overflow: hidden; /* Hide overflow for rounded corners */
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .media-item-card:hover {
        transform: translateY(-5px) scale(1.01);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .media-item-card img, .media-item-card video {
        width: 100%;
        height: 200px; /* Fixed height for consistency */
        object-fit: cover;
        display: block;
    }
    .media-caption-body {
        padding: 1rem;
        text-align: center;
        font-size: 0.9rem;
        color: #6c757d;
        line-height: 1.4;
    }
    .no-media-message {
        text-align: center;
        padding: 3rem;
        background-color: #e9ecef;
        border-radius: 12px;
        color: #6c757d;
        font-style: italic;
        box-shadow: inset 0 1px 5px rgba(0,0,0,0.03);
    }
    /* Styles to make image/video clickable area */
    .media-item-card a {
        display: block;
        height: 100%; /* Make the whole card clickable */
        text-decoration: none; /* Remove underline from link */
        color: inherit; /* Inherit text color */
    }
    .media-item-card a img, .media-item-card a video {
        pointer-events: none; /* Prevent double click behavior if link is used */
    }
    .media-item-card .media-content {
        cursor: pointer; /* Indicate clickability */
        position: relative; /* For play icon positioning */
    }
    .media-item-card .play-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3rem;
        color: rgba(255, 255, 255, 0.8);
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        padding: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none; /* Do not interfere with link click */
    }
    .media-item-card .media-content:hover .play-icon {
        opacity: 1;
    }


    /* Comments Section */
    .comments-section {
        margin-top: 2.5rem;
    }
    .comments-list {
        background-color: #ffffff;
        border-radius: 12px;
        padding: 2.5rem;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
    }
    .comment-item {
        border-bottom: 1px solid #e9ecef; /* Separator */
        padding-bottom: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .comment-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    .comment-header {
        display: flex;
        align-items: center;
        margin-bottom: 0.7rem;
    }
    .comment-author {
        font-weight: 700;
        color: #333;
        font-size: 1.1rem;
    }
    .comment-date {
        font-size: 0.85rem;
        color: #999;
        margin-left: 0.8rem;
    }
    .comment-text {
        color: #495057;
        line-height: 1.6;
        font-size: 1rem;
    }
    .no-comments-alert {
        padding: 2rem;
        background-color: #e9f5ff;
        border-color: #b8daff;
        color: #004085;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    /* Comment Form */
    .comment-form-card {
        background-color: #ffffff;
        border-radius: 12px;
        padding: 2.5rem;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
    }
    .form-control {
        border-radius: 8px;
        padding: 0.75rem 1rem;
        border: 1px solid #ced4da;
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
    }
    .btn-submit-form {
        background-color: #007bff; /* Primary blue button */
        color: #fff;
        border-radius: 8px;
        padding: 0.75rem 1.8rem;
        font-weight: 600;
        transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    .btn-submit-form:hover {
        background-color: #0056b3; /* Darker blue on hover */
        transform: translateY(-2px);
        color: #fff;
    }
    .btn-submit-form:active {
        transform: translateY(0);
    }


    /* Responsive adjustments */
    @media (max-width: 767.98px) {
        h1 { font-size: 2rem; }
        h2 { font-size: 1.8rem; }
        h3 { font-size: 1.5rem; }
        .content-card { padding: 1.5rem; }
        .status-badge { font-size: 0.95rem; padding: 0.5rem 1rem; }
        .media-grid { grid-template-columns: 1fr; } /* Single column on small screens */
        .comments-list, .comment-form-card { padding: 1.5rem; }

        /* Mobile Progress Bar adjustments */
        .progress-timeline {
            flex-direction: column;
            align-items: flex-start;
            padding: 0;
            margin-left: 30px;
            width: calc(100% - 30px);
        }
        .progress-timeline-line {
            width: 6px;
            height: calc(100% - 60px);
            left: 30px;
            top: 30px;
            transform: none;
        }
        .progress-line-fill {
            width: 6px;
            height: 0;
            left: 30px;
            top: 30px;
            transform: none;
        }
        .progress-step {
            flex-direction: row;
            text-align: left;
            margin-bottom: 2.5rem;
            align-items: center;
            width: 100%;
            padding-top: 0;
        }
        .progress-step:last-child {
            margin-bottom: 0;
        }
        .progress-step-icon-wrapper {
            position: static;
            transform: none;
            margin-right: 1.5rem;
            flex-shrink: 0;
        }
        .progress-step.completed .progress-step-icon-wrapper {
            transform: none;
        }
        .progress-step-label {
            white-space: normal;
            flex-grow: 1;
            margin-top: 0;
        }
    }

    /* Review Section Styles */
    .review-section {
        margin-top: 2.5rem;
    }

    .review-card {
        background-color: #ffffff;
        border-radius: 12px;
        padding: 2.5rem;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
        border-left: 5px solid #28a745; /* Green accent for positive review */
    }
    .review-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        border-bottom: 1px dashed #e9ecef;
        padding-bottom: 1rem;
    }
    .review-rating {
        font-size: 1.8rem;
        color: #ffc107; /* Yellow for stars */
    }
    .review-date {
        font-size: 0.9rem;
        color: #999;
    }
    .review-text {
        font-size: 1.1rem;
        line-height: 1.7;
        color: #495057;
    }
    .no-review-alert {
        padding: 2rem;
        background-color: #fff3cd; /* Light yellow alert */
        border-color: #ffeeba;
        color: #856404;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .star-rating .fas {
        color: #ffc107; /* Golden color for stars */
    }
</style>
{% endblock %}

{% block content %}
<section class="main-detail-section">
    <div class="container text-center">
        <h1 class="mb-4">Детали Заказа №{{ order.order_number }}</h1>
        <div class="d-flex justify-content-center mb-5">
            <span class="status-badge
                {% if order.order_status.name == 'Завершен' %}status-completed{% elif order.order_status.name == 'Отменен' %}status-canceled{% else %}status-in-progress{% endif %}">
                <i class="fas fa-info-circle me-2"></i> Текущий статус: {{ order.order_status.name }}
            </span>
        </div>

        {# Прогресс-бар Section #}
        <div class="content-card progress-section">
            <h2>Статус выполнения заказа</h2>
            <div class="progress-timeline" id="orderProgressBar">
                <div class="progress-timeline-line"></div>
                <div class="progress-line-fill"></div>

                {% for status in all_order_statuses %}
                    {# Исключаем "Отменен" и "Новый заказ" из основной линии прогресса, если они не являются этапами выполнения #}
                    {% if status.name != 'Отменен' and status.name != 'Новый заказ' %}
                        <div class="progress-step {% if order.order_status.order_index == status.order_index %}current{% elif order.order_status.order_index > status.order_index %}completed{% endif %}" data-status-index="{{ status.order_index }}">
                            <div class="progress-step-icon-wrapper">
                                {# Иконки Font Awesome для каждого статуса #}
                                {% if status.name == 'Замер' %}<i class="fas fa-ruler-combined"></i>
                                {% elif status.name == 'Дизайн' %}<i class="fas fa-pencil-ruler"></i>
                                {% elif status.name == 'Деталировка' %}<i class="fas fa-clipboard-list"></i>
                                {% elif status.name == 'Производство' %}<i class="fas fa-industry"></i>
                                {% elif status.name == 'Упаковка' %}<i class="fas fa-box"></i>
                                {% elif status.name == 'Доставка' %}<i class="fas fa-truck"></i>
                                {% elif status.name == 'Установка' %}<i class="fas fa-wrench"></i>
                                {% elif status.name == 'Завершен' %}<i class="fas fa-check-circle"></i>
                                {% else %}<i class="fas fa-question-circle"></i> {# Иконка по умолчанию #}
                                {% endif %}
                            </div>
                            <span class="progress-step-label">{{ status.name }}</span>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <p class="text-muted small mt-4">Текущий статус заказа: <strong>{{ order.order_status.name }}</strong></p>
        </div>

        {# Общая информация о заказе #}
        <div class="content-card order-info">
            <h2>Подробная информация о заказе</h2>
            <p><strong>Описание:</strong> {{ order.description|default:"Описание заказа отсутствует." }}</p>
            <div class="meta-data">
                <p class="mb-1"><i class="fas fa-calendar-alt me-2"></i>Создан: {{ order.created_at|date:"d M Y H:i" }}</p>
                <p class="mb-0"><i class="fas fa-sync-alt me-2"></i>Последнее обновление: {{ order.updated_at|date:"d M Y H:i" }}</p>
            </div>
        </div>

        {# Секция Медиа #}
        <div class="content-card media-section">
            <h2>Фото и видеоотчет о процессе</h2>
            <div class="media-gallery-container">
                {% if order_media %}
                    <div class="media-grid">
                        {% for media in order_media %}
                        <div class="media-item-card">
                            {% with file_extension=media.file.url|lower|slice:"-3:" %}
                                {% if file_extension == "mp4" or file_extension == "mov" or file_extension == "avi" or file_extension == "webm" %}
                                    {# Для видео используем data-lightbox и data-title #}
                                    <a href="{{ media.file.url }}" data-lightbox="order-gallery" data-title="Этап: {{ media.order_stage.name|default:'Не указан' }} ({{ media.uploaded_at|date:'d M Y H:i' }})">
                                        <div class="media-content">
                                            <video controls class="img-fluid" preload="metadata">
                                                <source src="{{ media.file.url }}#t=0.5" type="video/mp4"> {# #t=0.5 для отображения первого кадра как превью #}
                                                Ваш браузер не поддерживает видео тег.
                                            </video>
                                            <div class="play-icon"><i class="fas fa-play-circle"></i></div>
                                        </div>
                                    </a>
                                {% else %}
                                    {# Для изображений используем data-lightbox и data-title #}
                                    <a href="{{ media.file.url }}" data-lightbox="order-gallery" data-title="Этап: {{ media.order_stage.name|default:'Не указан' }} ({{ media.uploaded_at|date:'d M Y H:i' }})">
                                        <div class="media-content">
                                            <img src="{{ media.file.url }}" class="img-fluid" alt="Медиа к заказу">
                                        </div>
                                    </a>
                                {% endif %}
                            {% endwith %}
                            <div class="media-caption-body">
                                <p class="mb-0" >Этап: <strong>{{ media.order_stage.name|default:"Не указан" }}</strong></p>
                                <small class="text-muted">{{ media.uploaded_at|date:"d M Y H:i" }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-media-message">
                        <i class="fas fa-camera fa-2x mb-3"></i>
                        <p>На данный момент фото и видео для этого заказа отсутствуют.</p>
                    </div>
                {% endif %}
            </div>
        </div>
         {# Секция Отзыва #}
        {% if order.is_completed  %}
            <div class="content-card review-section">
                <h2 id="review-section">Отзыв о заказе</h2>
                {% if order.review and order.review.is_published %}
                    <div class="review-card">
                        <div class="review-header">
                            <div class="star-rating">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= order.review.rating %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="review-date">{{ order.review.created_at|date:"d M Y H:i" }}</span>
                        </div>
                        <p class="review-text">"{{ order.review.text }}"</p>
                    </div>
                {% else %}
                    <div class="no-review-alert">
                        <i class="fas fa-star-half-alt fa-2x mb-3"></i>
                        <p>На данный момент отзыв по этому заказу отсутствует.</p>
                    </div>
                {% endif %}
            </div>
        {% endif %}

        {# Секция Комментариев #}
        <div class="content-card comments-section">
            <h2 id="comments-section">Комментарии</h2>
            <div class="comments-list">
                {% if comments %}
                    {% for comment in comments %}
                    <div class="comment-item">
                        <div class="comment-header">
                            <span class="comment-author">{{ comment.author_name }}</span>
                            <span class="comment-date"><i class="fas fa-clock me-1"></i>{{ comment.created_at|date:"d M Y H:i" }}</span>
                        </div>
                        <p class="comment-text">{{ comment.text }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-comments-alert">
                        <i class="fas fa-comment-dots fa-2x mb-3"></i>
                        <p>На данный момент комментариев нет. Будьте первым!</p>
                    </div>
                {% endif %}
            </div>

            {# Форма для добавления нового комментария #}
            <div class="comment-form-card mt-4">
                <h3 class="mb-4">Оставить новый комментарий</h3>
                {# Проверьте, что в вашем urls.py есть соответствующий url для обработки POST запроса #}
                <form method="post" action="{% url 'orders:public_order_detail' order.order_number %}#comments-section">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="{{ comment_form.author_name.id_for_label }}" class="form-label">Ваше имя:</label>
                        {{ comment_form.author_name }}
                        {% if comment_form.author_name.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in comment_form.author_name.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ comment_form.text.id_for_label }}" class="form-label">Комментарий:</label>
                        {{ comment_form.text }}
                        {% if comment_form.text.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in comment_form.text.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    {% if comment_form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ comment_form.non_field_errors }}
                        </div>
                    {% endif %}
                    <button type="submit" name="submit_comment" class="btn btn-submit-form mt-3">
                        <i class="fas fa-paper-plane me-2"></i>Отправить комментарий
                    </button>
                </form>
            </div>
        </div>

    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Инициализация тултипов Bootstrap, если они используются
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // Настройка Lightbox2 (опционально, но полезно)
    lightbox.option({
        'resizeDuration': 200,
        'wrapAround': true,
        'albumLabel': 'Изображение %1 из %2', // Кастомизация надписи в галерее
        'fadeDuration': 300,
        'imageFadeDuration': 300
    })

    // --- Улучшенная Логика для Прогресс-Бара ---
    function updateProgressBar() {
        const progressBar = document.getElementById('orderProgressBar');
        if (!progressBar) return;

        const currentStatusIndex = {{ order.order_status.order_index }};
        const allSteps = Array.from(progressBar.querySelectorAll('.progress-step')); // Преобразуем в массив
        const fillLine = progressBar.querySelector('.progress-line-fill');

        // Отфильтровываем шаги, которые не отображаются в прогресс-баре (например, "Отменен", "Новый заказ")
        const visibleSteps = allSteps.filter(step => {
            const statusName = step.querySelector('.progress-step-label').textContent.trim();
            return statusName !== 'Отменен' && statusName !== 'Новый заказ';
        });

        const totalVisibleSteps = visibleSteps.length;

        if (totalVisibleSteps === 0) {
            fillLine.style.width = '0%';
            fillLine.style.height = '0px';
            return;
        }

        // Горизонтальный режим (для больших экранов)
        if (window.innerWidth >= 768) {
            let percentage = 0;
            // Находим индекс текущего видимого шага
            const currentVisibleStepIndex = visibleSteps.findIndex(step => parseInt(step.dataset.statusIndex) === currentStatusIndex);

            if (totalVisibleSteps > 1 && currentVisibleStepIndex !== -1) {
                percentage = (currentVisibleStepIndex) / (totalVisibleSteps - 1) * 100;
            } else if (totalVisibleSteps === 1 && currentVisibleStepIndex === 0) {
                percentage = 100;
            } else if (currentVisibleStepIndex === -1 && currentStatusIndex < Math.min(...visibleSteps.map(s => parseInt(s.dataset.statusIndex)))) {
                percentage = 0;
            } else if (currentVisibleStepIndex === -1 && currentStatusIndex > Math.max(...visibleSteps.map(s => parseInt(s.dataset.statusIndex)))) {
                // Если текущий статус выше всех видимых (например, "Отменен"), линия должна быть полной
                percentage = 100;
            }


            fillLine.style.width = `${percentage}%`;
            fillLine.style.height = '6px';
            fillLine.style.top = '30px';
            fillLine.style.left = '0';
            fillLine.style.transform = 'translateY(-50%)';
        }
        // Вертикальный режим (для мобильных)
        else {
            let filledHeight = 0;
            let currentVisibleStepElement = null;

            // Ищем элемент текущего статуса
            currentVisibleStepElement = visibleSteps.find(step => parseInt(step.dataset.statusIndex) === currentStatusIndex);

            if (currentVisibleStepElement) {
                const iconWrapper = currentVisibleStepElement.querySelector('.progress-step-icon-wrapper');
                if (iconWrapper) {
                    // Высота обертки иконки от верхнего края родительского элемента
                    const iconOffsetTop = iconWrapper.offsetTop;
                    // Середина иконки относительно ее обертки
                    const iconCenter = iconOffsetTop + iconWrapper.offsetHeight / 2;
                    filledHeight = iconCenter;
                }
            } else if (currentStatusIndex < Math.min(...visibleSteps.map(s => parseInt(s.dataset.statusIndex)))) {
                filledHeight = 0;
            } else if (currentStatusIndex > Math.max(...visibleSteps.map(s => parseInt(s.dataset.statusIndex)))) {
                const lastVisibleStepElement = visibleSteps[visibleSteps.length - 1];
                const lastIconWrapper = lastVisibleStepElement.querySelector('.progress-step-icon-wrapper');
                filledHeight = lastIconWrapper.offsetTop + lastIconWrapper.offsetHeight / 2;
            }

            fillLine.style.height = `${filledHeight}px`;
            fillLine.style.width = '6px';
            fillLine.style.top = '30px';
            fillLine.style.left = '30px';
            fillLine.style.transform = 'none';
        }
    }

    // Вызываем при загрузке и при изменении размера окна (для адаптивности)
    updateProgressBar();
    window.addEventListener('resize', updateProgressBar);
});
</script>
{% endblock %}