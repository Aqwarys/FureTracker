{% extends "base.html" %}
{% load static %}

{% block title %}Заказ №{{ order.order_number }}{% endblock %}

{% block extra_head %}
{# Подключение Font Awesome и GLightbox через CDN. Это внешние библиотеки, которые не должны быть в вашей статике на S3. #}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-5vUu+zB9jU4l6Z10a6l+1gWfW5+pB+J+Gg+Gg+Q+Gg+Gg+Gg+Gg+Gg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
{# Ваш собственный CSS-файл, который теперь должен загружаться с S3 через STATIC_URL. #}
<link rel="stylesheet" href="{% static 'css/order_detail.css' %}">
{% endblock %}

{% block content %}
<section class="order-detail-page main-detail-section">
    <div class="container text-center">
        <h1 class="mb-4">Детали Заказа №{{ order.order_number }}</h1>
        <div class="d-flex justify-content-center mb-5">
            <span class="status-badge
                {% if order.order_status.name == 'Завершен' %}status-completed{% elif order.order_status.name == 'Отменен' %}status-canceled{% else %}status-in-progress{% endif %}">
                <i class="fas fa-info-circle me-2"></i> Текущий статус: {{ order.order_status.name }}
            </span>
        </div>

        {# Секция Прогресс-бара #}
        <div class="content-card progress-section">
            <h2>Статус выполнения заказа</h2>
            <div class="progress-timeline" id="orderProgressBar">
                <div class="progress-timeline-line"></div>
                <div class="progress-line-fill"></div>

                {% for status in all_order_statuses %}
                    {% if status.name != 'Отменен' %}
                        <div class="progress-step {% if order.order_status.order_index == status.order_index %}current{% elif order.order_status.order_index > status.order_index %}completed{% endif %}" data-status-index="{{ status.order_index }}">
                            <div class="progress-step-icon-wrapper">
                                {# Иконки Font Awesome для каждого статуса #}
                                {% if status.name == 'Замер' %}<i class="fas fa-ruler-combined"></i>
                                {% elif status.name == 'Дизайн' %}<i class="fas fa-pencil-ruler"></i>
                                {% elif status.name == 'Технолог' %}<i class="fas fa-drafting-compass"></i>
                                {% elif status.name == 'Деталировка' %}<i class="fas fa-clipboard-list"></i>
                                {% elif status.name == 'Менеджер' %}<i class="fas fa-user-tie"></i>
                                {% elif status.name == 'Распил' %}<i class="fas fa-cut"></i>
                                {% elif status.name == 'Закатка' %}<i class="fas fa-grip-lines-vertical"></i>
                                {% elif status.name == 'ЧПУ' %}<i class="fas fa-cogs"></i>
                                {% elif status.name == 'Вакум | Покраска' %}<i class="fas fa-paint-roller"></i>
                                {% elif status.name == 'Сборка' %}<i class="fas fa-puzzle-piece"></i>
                                {% elif status.name == 'Упаковка' %}<i class="fas fa-box-open"></i>
                                {% elif status.name == 'Доставка' %}<i class="fas fa-truck-loading"></i>
                                {% elif status.name == 'Монтаж' %}<i class="fas fa-tools"></i>
                                {% elif status.name == 'Завершен' %}<i class="fas fa-check-circle"></i>
                                {% else %}<i class="fas fa-question-circle"></i> {# Иконка по умолчанию #}
                                {% endif %}
                            </div>
                            <span class="progress-step-label">{{ status.name }}</span>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <p class="text-muted small mt-4">Текущий статус заказа: <strong>{{ order.order_status.name }}</strong></p>
        </div>

        {# Секция общей информации о заказе #}
        <div class="content-card order-info">
            <h2>Подробная информация о заказе</h2>
            <p><strong>Описание:</strong> {{ order.description|default:"Описание заказа отсутствует." }}</p>
            <div class="meta-data">
                <p class="mb-1"><i class="fas fa-calendar-alt me-2"></i>Создан: {{ order.created_at|date:"d M Y H:i" }}</p>
                <p class="mb-0"><i class="fas fa-sync-alt me-2"></i>Последнее обновление: {{ order.updated_at|date:"d M Y H:i" }}</p>
            </div>

            {# Добавляем даты этапов, если они существуют #}
            <div class="stage-dates mt-4 pt-3 border-top">
                {% if order.stage_measurement_date %}
                    <p class="mb-1"><i class="fas fa-ruler-combined me-2"></i><strong>Дата замера:</strong> {{ order.stage_measurement_date|date:"d M Y" }}</p>
                {% endif %}
                {% if order.stage_design_date %}
                    <p class="mb-1"><i class="fas fa-pencil-ruler me-2"></i><strong>Дата утверждения дизайна:</strong> {{ order.stage_design_date|date:"d M Y" }}</p>
                {% endif %}
                {% if order.stage_technologist_date %}
                    <p class="mb-1"><i class="fas fa-drafting-compass me-2"></i><strong>Дата работы технолога:</strong> {{ order.stage_technologist_date|date:"d M Y" }}</p>
                {% endif %}
                {% if order.stage_completion_date %}
                    <p class="mb-1"><i class="fas fa-check-circle me-2"></i><strong>Дата завершения заказа:</strong> {{ order.stage_completion_date|date:"d M Y" }}</p>
                {% endif %}
            </div>
        </div>

        {# Секция Медиафайлов #}
        <div class="content-card media-section">
            <h2>Фото и видеоотчет о процессе</h2>

            {# Новая форма для загрузки медиа #}
            {% if request.user.is_staff %}
            <div class="upload-media-form-container mt-4 mb-4">
                <h3>Загрузить новое медиа</h3>
                <form id="s3-upload-form" method="post" enctype="multipart/form-data"
                data-presigned-url="{% url 'orders:get_s3_presigned_url' %}" {# Передаем URL для получения подписанного URL #}
                data-complete-upload-url="{% url 'orders:complete_s3_upload' %}" {# Передаем URL для завершения загрузки #}
                data-order-number="{{ order.order_number }}"> {# Передаем номер заказа #}
                {% csrf_token %}
                {{ order_media_form.order_stage }} {# Поле выбора статуса #}

                <div class="mb-3">
                    <label for="id_media_file" class="form-label">Выберите файл (фото или видео):</label>
                    <input type="file" id="id_media_file" name="media_file" class="form-control" accept="image/*,video/*">
                </div>

                <button type="button" id="upload-to-s3-btn" class="btn btn-primary mt-3">
                    <i class="fas fa-cloud-upload-alt me-2"></i> Начать загрузку
                </button>

                <div class="progress mt-3" style="display: none;">
                    <div class="progress-bar" role="progressbar" id="upload-progress-bar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <div id="upload-status-message" class="mt-2 text-info"></div>
            </form>
            </div>
            {% endif %}

            <div class="media-gallery-container">
                {% if order_media %}
                    <div class="media-grid">
                        {% for media in order_media %}
                        <div class="media-item-card">
                            {% with file_ext=media.file.url|lower|slice:"-3:" %}
                                {% if file_ext == 'mp4' or file_ext == 'mov' or file_ext == 'avi' or file_ext == 'webm' %}
                                    {# Для видео используем GLightbox #}
                                    <a href="{{ media.file.url }}" class="glightbox" data-type="video">
                                        <div class="video-thumb">
                                            <video preload="metadata" class="img-fluid" {% if media.thumbnail_url %}poster="{{ media.thumbnail_url }}"{% endif %}>
                                                <source src="{{ media.file.url }}" type="video/mp4">
                                                {% if file_ext == 'mov' %}
                                                    <source src="{{ media.file.url }}" type="video/quicktime">
                                                {% endif %}
                                                Ваш браузер не поддерживает тег video.
                                            </video>
                                            <div class="play-icon"><i class="fas fa-play-circle"></i></div>
                                        </div>
                                    </a>
                                {% else %}
                                    {# Для изображений используется GLightbox #}
                                    <a href="{{ media.file.url }}" class="glightbox" data-type="image">
                                        <img src="{{ media.file.url }}" class="img-fluid" alt="Медиа">
                                    </a>
                                {% endif %}
                            {% endwith %}
                            <div class="media-caption-body">
                                <p class="mb-0">Этап: <strong>{{ media.order_stage.name|default:"Не указан" }}</strong></p>
                                <small class="text-muted">{{ media.uploaded_at|date:"d M Y H:i" }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-media-message">
                        <i class="fas fa-camera fa-2x mb-3"></i>
                        <p>На данный момент фото и видео для этого заказа отсутствуют.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        {# Секция Отзыва #}
        {% if order.is_completed %}
            <div class="content-card review-section">
                <h2 id="review-section">Отзыв о заказе</h2>
                {% if order.review and order.review.is_published %}
                    <div class="review-card">
                        <div class="review-header">
                            <div class="star-rating">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= order.review.rating %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="review-date">{{ order.review.created_at|date:"d M Y H:i" }}</span>
                        </div>
                        <p class="review-text">"{{ order.review.text }}"</p>
                    </div>
                {% else %}
                    <div class="no-review-alert">
                        <i class="fas fa-star-half-alt fa-2x mb-3"></i>
                        <p>На данный момент отзыв по этому заказу отсутствует.</p>
                    </div>
                {% endif %}
            </div>
        {% endif %}

        {# Секция Комментариев #}
        <div class="content-card comments-section">
            <h2 id="comments-section">Комментарии</h2>
            <div class="comments-list">
                {% if comments %}
                    {% for comment in comments %}
                    <div class="comment-item">
                        <div class="comment-header">
                            <span class="comment-author">{{ comment.author_name }}</span>
                            <span class="comment-date"><i class="fas fa-clock me-1"></i>{{ comment.created_at|date:"d M Y H:i" }}</span>
                        </div>
                        <p class="comment-text">{{ comment.text }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-comments-alert">
                        <i class="fas fa-comment-dots fa-2x mb-3"></i>
                        <p>На данный момент комментариев нет. Будьте первым!</p>
                    </div>
                {% endif %}
            </div>

            {# Форма для добавления нового комментария #}
            <div class="comment-form-card mt-4">
                <h3 class="mb-4">Оставить новый комментарий</h3>
                <form method="post" action="{% url 'orders:public_order_detail' order.order_number %}#comments-section">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="{{ comment_form.author_name.id_for_label }}" class="form-label">Ваше имя:</label>
                        {{ comment_form.author_name }}
                        {% if comment_form.author_name.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in comment_form.author_name.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ comment_form.text.id_for_label }}" class="form-label">Комментарий:</label>
                        {{ comment_form.text }}
                        {% if comment_form.text.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in comment_form.text.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    {% if comment_form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ comment_form.non_field_errors }}
                        </div>
                    {% endif %}
                    <button type="submit" name="submit_comment" class="btn btn-submit-form mt-3">
                        <i class="fas fa-paper-plane me-2"></i>Отправить комментарий
                    </button>
                </form>
            </div>
        </div>

    </div>
</section>
{% endblock %}

{% block extra_js %}
{# jQuery - если он вам нужен, оставьте. Если нет - удалите, чтобы уменьшить размер страницы. #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" xintegrity="sha512-5vUu+zB9jU4l6Z10a6l+1gWfW5+pB+J+Gg+Gg+Q+Gg+Gg+Gg+Gg+Gg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{# GLightbox JavaScript #}
<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    GLightbox({
        selector: '.glightbox',
        touchNavigation: true,
        loop: true,
        autoplayVideos: true
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    function updateProgressBar() {
        const progressBar = document.getElementById('orderProgressBar');
        if (!progressBar) return;

        const currentStatusIndex = {{ order.order_status.order_index }};
        const allSteps = Array.from(progressBar.querySelectorAll('.progress-step'));
        const fillLine = progressBar.querySelector('.progress-line-fill');

        const visibleSteps = allSteps.filter(step => {
            const statusName = step.querySelector('.progress-step-label').textContent.trim();
            return statusName !== 'Отменен' && statusName !== 'Новый заказ';
        });

        const totalVisibleSteps = visibleSteps.length;
        if (totalVisibleSteps === 0) {
            fillLine.style.width = '0%';
            return;
        }

        let percentage = 0;
        const currentVisibleStepIndex = visibleSteps.findIndex(
            step => parseInt(step.dataset.statusIndex) === currentStatusIndex
        );

        if (totalVisibleSteps > 1 && currentVisibleStepIndex !== -1) {
            percentage = (currentVisibleStepIndex) / (totalVisibleSteps - 1) * 100;
        } else if (totalVisibleSteps === 1 && currentVisibleStepIndex === 0) {
            percentage = 100;
        } else if (
            currentVisibleStepIndex === -1 &&
            currentStatusIndex < Math.min(...visibleSteps.map(s => parseInt(s.dataset.statusIndex)))
        ) {
            percentage = 0;
        } else if (
            currentVisibleStepIndex === -1 &&
            currentStatusIndex > Math.max(...visibleSteps.map(s => parseInt(s.dataset.statusIndex)))
        ) {
            percentage = 100;
        }

        fillLine.style.width = `${percentage}%`;
    }

    updateProgressBar();
    window.addEventListener('resize', updateProgressBar);
});
</script>

{# Подключаем Axios (для AJAX-запросов) #}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
{# Ваш кастомный JavaScript для S3 загрузки #}
<script src="{% static 'js/s3_upload.js' %}"></script>
{% endblock %}
